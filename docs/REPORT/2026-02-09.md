# 일일 개발 보고서 - 2026-02-09

## 오늘의 Git 활동

### 커밋 목록
- `902026a` Fix report deletion: add missing DELETE RLS policies and child table cleanup
- `41ddc20` Add report deletion and bulk photo upload features

### 변경 통계
- 코드: 1 file changed (ReportDetail.tsx - 삭제 로직 보완)
- Supabase 마이그레이션: 7개 적용 (보안 + 성능)

## Supabase 마이그레이션 (7개)

| # | 마이그레이션 | 설명 |
|---|------------|------|
| 1 | `add_delete_rls_policies` | weekly_reports 등 5개 테이블 DELETE RLS 정책 추가 |
| 2 | `fix_security_errors_enable_rls` | 5개 테이블 RLS 활성화, 뷰 SECURITY INVOKER 변경 |
| 3 | `fix_security_warns_functions_and_policies` | 함수 search_path 설정, public→authenticated 정책 전환 |
| 4 | `fix_performance_indexes` | FK 인덱스 15개 추가, 미사용 인덱스 8개 삭제 |
| 5 | `fix_performance_policies_part1` | 중복 정책 제거, initplan 최적화 (notifications, weekly_reports 등) |
| 6 | `fix_performance_policies_part2` | initplan 최적화 (expense_requests, accounting_records 등) |
| 7 | `fix_remaining_unindexed_fkeys` | FK 인덱스 5개 추가 (accounting, expense, push_subscriptions 등) |

## 변경된 파일

| 파일 | 상태 | 설명 |
|------|------|------|
| `src/components/reports/ReportDetail.tsx` | M | 보고서 삭제 시 누락된 자식 테이블 3개 추가 (attendance_records, notifications, report_photos) |

## 완료한 작업

1. **보고서 삭제 버그 수정**
   - 증상: 1월 25일 테스트 보고서 삭제 시 무반응 (2월 보고서는 정상)
   - 원인: `weekly_reports` 테이블에 DELETE RLS 정책 없음 → Supabase가 삭제를 무시
   - 수정: DELETE RLS 정책 5개 테이블에 추가 + 코드에서 누락된 자식 테이블 3개 삭제 로직 추가
   - 자식 테이블 전체 순서: report_programs → newcomers → approval_history → attendance_records → notifications → report_photos → weekly_reports

2. **Supabase 보안 강화 (Security Advisor)**
   - ERROR 7개 → 0개 해결
     - RLS 미활성화 테이블 5개 활성화 (departments, user_departments, approval_history, report_programs, push_subscriptions)
     - SECURITY DEFINER 뷰 2개 → SECURITY INVOKER로 변경
   - WARN 해결
     - 함수 4개에 `search_path = ''` 설정
     - public 역할 정책 11개 → authenticated로 교체 (익명 접근 차단)
   - 남은 항목: Leaked Password Protection (대시보드에서 수동 활성화 필요)

3. **Supabase 성능 최적화 (Performance Advisor)**
   - initplan WARN 22개 → 0개: `auth.uid()` → `(select auth.uid())` 변환
   - 중복 정책 WARN 9개 → 0개: 중복 permissive 정책 통합/제거
   - 미인덱스 FK INFO 20개 → 0개: FK 인덱스 20개 추가, 미사용 8개 삭제
   - 최종 결과: Performance Advisor 0 WARN, 0 INFO

4. **앱 테스트 및 배포**
   - `npm run build` 성공
   - 핵심 DB 쿼리 (members, reports, users 등) 정상 동작 확인
   - Vercel 프로덕션 배포 완료

## 업데이트된 문서

| 문서 | 변경 내용 |
|------|-----------|
| `docs/status/04-database.md` | RLS 보안 섹션, 인덱스 섹션, 마이그레이션 7개 추가 |

## 내일 할 일 (자동 제안)

- [ ] Leaked Password Protection 대시보드에서 활성화
- [ ] 팀장 계정으로 교인 목록 접근 테스트 (members SELECT 정책 변경 영향)
- [ ] Lighthouse 재측정 및 성능 확인
- [ ] 웹 푸시 알림 (Phase 2) - Service Worker, 백그라운드 알림
- [ ] iPhone Safari PWA 테스트

## 메모

- Supabase RLS에서 DELETE 정책이 없으면 삭제가 **에러 없이 무시됨** (silent failure)
- `auth.uid()`를 `(select auth.uid())`로 감싸면 RLS 정책이 행마다 재평가하지 않아 성능 향상 (initplan 최적화)
- 같은 테이블/역할/action에 여러 permissive 정책이 있으면 OR로 결합되어 성능 저하 → 하나로 통합
- `members` SELECT 정책에서 기존 broad `true` 정책 제거 → accountant 역할 추가하여 보완
