# 일일 개발 보고서 - 2026-02-09

## 오늘의 Git 활동

### 커밋 목록
- `5f99845` Add report statistics dashboard with tab UI on stats page
- `4693462` Add PWA icon generation script
- `3e7d45f` Fix SW activation failure: add missing PWA icons, remove invalid pageshow listener
- `ab10219` Fix SW activation: send SKIP_WAITING and poll for active state on iOS
- `147b95d` Debug push: show step-by-step progress and detailed error for iOS diagnosis
- `6524362` Fix SW timeout: register service worker explicitly before push subscribe
- `3c4b9e2` Fix push subscribe: add timeouts, error display, PushManager check, iOS PWA detection
- `2b04e42` Improve unsupported push message: add iOS home screen install guide
- `a0d46d8` Fix push permission button hidden by overflow, add unsupported browser message
- `15aed2d` Fix push.ts: lazy VAPID init to prevent build-time module error
- `8055f38` Add web push notifications: subscribe, send, and service worker handlers
- `ac7169a` Update docs: add RLS/index/migration sections and daily report
- `902026a` Fix report deletion: add missing DELETE RLS policies and child table cleanup
- `41ddc20` Add report deletion and bulk photo upload features

### 미커밋 변경 (셀별 필터 기능)
- 20 files changed, 485 insertions(+), 108 deletions(-)
- DB 마이그레이션 + 타입 + 쿼리 훅 + UI 적용 완료 (미커밋)

### 커밋된 변경 통계
- 17 files changed, 961 insertions(+), 71 deletions(-)

## 변경된 파일

### 커밋된 파일

| 파일 | 상태 | 설명 |
|------|------|------|
| `src/components/notifications/PushPermission.tsx` | A | 웹 푸시 구독/해제 UI 컴포넌트 |
| `src/lib/push.ts` | A | 서버 사이드 푸시 전송 유틸리티 (web-push) |
| `src/app/api/push/subscribe/route.ts` | A | 푸시 구독 등록 API |
| `src/app/api/push/unsubscribe/route.ts` | A | 푸시 구독 해제 API |
| `src/app/api/push/send/route.ts` | A | 푸시 전송 API |
| `src/components/notifications/NotificationBell.tsx` | M | PushPermission 통합, 스크롤 영역 조정 |
| `src/lib/notifications.ts` | M | triggerPush() 함수 추가 (fire-and-forget) |
| `public/sw.js` | M | push/notificationclick 핸들러, 캐싱 개선, pageshow 제거 |
| `public/icon-192.png` | A | PWA 아이콘 192x192 |
| `public/icon-512.png` | A | PWA 아이콘 512x512 |
| `scripts/generate-icons.mjs` | A | PWA 아이콘 생성 스크립트 (sharp) |
| `package.json` | M | web-push, @types/web-push 추가 |
| `src/components/reports/ReportDetail.tsx` | M | 삭제 시 누락된 자식 테이블 추가 |
| `src/components/stats/ReportStatsCharts.tsx` | A | 보고서 통계 차트 (파이, 라인, 바) |
| `src/components/stats/ReportStatsContent.tsx` | A | 보고서 통계 메인 컨텐츠 |
| `src/app/(dashboard)/stats/page.tsx` | M | 출결/보고서 통계 탭 전환 |

### 미커밋 파일 (셀별 필터)

| 파일 | 상태 | 설명 |
|------|------|------|
| `src/components/ui/CellFilter.tsx` | A | 셀 드롭다운 공통 컴포넌트 (cu1만 표시) |
| `src/types/database.ts` | M | cells 테이블 타입, cell_id 컬럼 추가 |
| `src/types/shared.ts` | M | CellInfo 인터페이스, cell_id 필드 추가 |
| `src/lib/constants.ts` | M | CU1_DEPARTMENT_CODE 상수 추가 |
| `src/queries/departments.ts` | M | useCells() 쿼리 훅 추가 |
| `src/components/members/MemberFilters.tsx` | M | 셀 드롭다운 추가 |
| `src/components/members/MemberList.tsx` | M | cell URL 파라미터 + 셀 필터링 로직 |
| `src/components/members/DepartmentSelector.tsx` | M | cu1 체크 시 셀 선택 드롭다운 |
| `src/components/members/MemberForm.tsx` | M | cell_id 저장 로직 |
| `src/app/(dashboard)/members/page.tsx` | M | cell_id 쿼리 추가, dept code 포함 |
| `src/app/(dashboard)/members/new/page.tsx` | M | dept 타입에 code 추가 |
| `src/app/(dashboard)/members/[id]/edit/page.tsx` | M | cell_id/code 쿼리 추가 |
| `src/components/attendance/AttendanceGrid.tsx` | M | 셀 필터 + memberCellMap |
| `src/app/(dashboard)/stats/page.tsx` | M | 셀 필터 추가 |

## 완료한 작업

### 1. 보고서 통계 대시보드
- 관련 파일: `src/components/stats/ReportStatsCharts.tsx`, `ReportStatsContent.tsx`
- `/stats` 페이지에 "출결 통계 | 보고서 통계" 탭 UI 추가
- 요약 카드 4개 (전체/승인/대기/반려)
- 차트 4개 (결재상태 파이, 제출추이 라인, 부서별 제출률 바, 결재소요시간 바)
- 부서별 상세 테이블 (모바일 카드 + 데스크탑 테이블)

### 2. 셀별 필터 기능 (단계 1~2 완료)
- 관련 파일: 위 미커밋 파일 목록 참조
- **단계 1**: DB 마이그레이션 (cells 테이블 + cell_id 컬럼) + TypeScript 타입 + useCells 쿼리 훅
- **단계 2**: CellFilter 공통 컴포넌트 생성 → 교인 명단, 출결 관리, 통계, 교인 등록/수정 4개 페이지에 적용
- 1청년부(cu1) 선택 시에만 셀 드롭다운 표시
- 부서 변경 시 셀 자동 초기화
- URL 파라미터로 셀 상태 유지 (`?dept=xxx&cell=yyy`)
- TypeScript 검사 통과, 빌드 성공

### 3. 웹 푸시 알림 구현 (전체)
- VAPID 키 + 서버 사이드 전송 + 클라이언트 구독/해제 UI
- Service Worker push/notificationclick 핸들러
- 결재 워크플로우 알림 시 자동 푸시 전송

### 4. iOS PWA 호환성 디버깅 (6회 반복 수정)
- 근본 원인: `cache.addAll()`에서 존재하지 않는 아이콘 → install 실패
- 해결: PWA 아이콘 생성 + 개별 cache.add + pageshow 리스너 제거

### 5. 보안/성능 (오전)
- 보고서 삭제 RLS 정책 추가
- Supabase Security/Performance Advisor 전체 해결

### 6. 문서 업데이트
- `04-database.md` - cells 테이블, cell_id 컬럼, RLS, 인덱스, 마이그레이션
- `02-features.md` - 셀별 필터링, 웹 푸시 기능
- `05-components.md` - CellFilter, PushPermission 컴포넌트
- `06-api.md` - useCells 훅, CellInfo 타입, 푸시 API

## 업데이트된 문서

| 문서 | 변경 내용 |
|------|-----------|
| `docs/status/02-features.md` | 셀별 필터링 기능, 웹 푸시 기능 추가 |
| `docs/status/04-database.md` | cells 테이블, cell_id, RLS, 인덱스, 마이그레이션 |
| `docs/status/05-components.md` | CellFilter, PushPermission 컴포넌트 문서화 |
| `docs/status/06-api.md` | useCells 훅, CellInfo, 푸시 API, VAPID 환경변수 |

## 내일 할 일

- [ ] 셀별 필터 기능 커밋 및 배포
- [ ] 단계 3: 셀 관리 페이지 (관리자 CRUD)
- [ ] 푸시 알림 E2E 테스트
- [ ] Leaked Password Protection 대시보드 활성화
- [ ] Lighthouse 재측정

## 메모

- `cells` 테이블: cu1 부서에 1셀~6셀 초기 데이터 삽입됨
- `member_departments.cell_id`는 nullable FK → cells
- `useCells()` 훅은 `staleTime: 10분`으로 설정 (셀 데이터는 자주 변하지 않음)
- CellFilter는 `React.memo`로 메모이제이션
- 셀 필터는 cu1 외 부서에서는 완전히 숨김 (UI 복잡도 최소화)
- 셀 관리 페이지(단계 3)는 미구현 상태
